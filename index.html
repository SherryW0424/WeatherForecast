<!DOCTYPE html>
<html>
<script type="text/javascript" src="js/jquery-3.2.1.min.js"></script>
<script type="text/javascript" src="js/bootstrap.min.js"></script>
<script type="text/javascript" src="js/echarts.min.js"></script>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
    <meta name="description" content="Tizen project: WeatherForecast"/>

    <title>WeatherForecast</title>

    <link rel="stylesheet" type="text/css" href="css/style.css"/>
    <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css"/>
    <link rel="stylesheet" type="text/css" href="css/weather.css"/>
    <link rel="stylesheet" type="text/css" href="css/button.css"/>
    <script src="js/main.js"></script>
    <script src="js/weather.js"></script>
</head>

<body>
    <div class="container-fluid">
        <div class="row-fluid">
            <div class="span12" style="margin-top: 0;">
                <h1 class="text-right" >
                    <span id="city">天津</span>
                    <button type="button" id="changeCity" class="button super">切换城市</button>
                </h1>
            </div>
        </div>
        <div class="row-fluid">
            <div class="span2">
                <p class="text-center">
                    相对湿度：<span id="hum"></span>%
                </p>
            </div>
            <div class="span2">
                <p class="text-center">
                    降水量：<span id="pcpn"></span>(mm)
                </p>
            </div>
            <div class="span2">
                <p class="text-center">
                    气压：<span id="pres"></span>(hPa)
                </p>
            </div>
            <div class="span2">
                <p class="text-center">
                    能见度：<span id="vis"></span>(km)
                </p>
            </div>
            <div class="span2">
                <p class="text-center">
                    风力：<span id="sc"></span>(级)
                </p>
            </div>
            <div class="span2">
                <p class="text-center">
                    风向：<span id="dir"></span>
                </p>
            </div>
        </div>
        <div class="row-fluid">
            <div class="span12">
                <h1 class="text-center">
                    <img id="weatherCode" scr=""/>
                    <span id="tmp"></span>℃&nbsp;
                    <span id="condition"></span>
                </h1>
            </div>
        </div>
        <div class="row-fluid">
            <div class="span12">
                <span style="padding-left: 10%">&nbsp;</span>
                <button id="hourf" class="button large blue">分时预报</button>
                <button id="dayf" class="button large blue">三天预报</button>
            </div>
        </div>
        <div class="row-fluid" id="hourShow1">
            <div class="span12">
                <table id="hourslyTable" style="width:92.5%;margin-left:4%;text-align: center;">
                    <tr></tr>
                    <tr></tr>
                </table>
            </div>
        </div>
        <div class="row-fluid" id="hourShow2">
            <div class="span12" id="hourslyChart" style="width:100%;height:400px;">
            </div>
        </div>
        <div class="row-fluid" id="dayShow" style="display: none">
            <div class="span12">
                <table id="foreastDay" style="width:92.5%;margin-left:4%;text-align: center; border-collapse:separate; border-spacing:0px 20px;">
                    <tr></tr>
                    <tr></tr>
                    <tr></tr>
                    <tr></tr>
                    <tr></tr>
                </table>
            </div>
        </div>
        <div class="row-fluid" style="padding-left:4em;">
            <div class="span1 liveSpan1">
                <img class="liveImg" src="images/liveIcon/drsg.png"/>
                <span class="liveTitle">穿衣指数</span>
            </div>
            <div class="span3 liveSpan3" id="drsg" style="margin-left: 0;">           
                <span class="brf"></span>
                <span class="txt"></span>
            </div>
            <div class="span1 liveSpan1">
                <img class="liveImg" src="images/liveIcon/zi.png"/>
                <span class="liveTitle">UV指数</span>
            </div>
            <div class="span3 liveSpan" id="uv" style="margin-left: 0;">  
                <span class="brf"></span>
                <span class="txt"></span>
            </div>
            <div class="span1 liveSpan1">
                <img class="liveImg" src="images/liveIcon/flu.png"/>
                <span class="liveTitle">感冒指数</span>
            </div>
            <div class="span3 liveSpan" id="flu" style="margin-left: 0;">
                <span class="brf"></span>
                <span class="txt"></span>
            </div>

        </div>
        <div class="row-fluid" style="padding-left:4em; padding-bottom: 5em">
            <div class="span1 liveSpan1">
                <img class="liveImg" src="images/liveIcon/car.png"/>
                <span class="liveTitle">洗车指数</span>
            </div>
            <div class="span3 liveSpan" id="cw" style="margin-left: 0;">   
                <span class="brf"></span>
                <span class="txt"></span>
            </div>
            <div class="span1 liveSpan1">
                <img class="liveImg" src="images/liveIcon/sport.png"/>
                <span class="liveTitle">运动指数</span>
            </div>
            <div class="span3 liveSpan" id="sport" style="margin-left: 0;">
                <span class="brf"></span>
                <span class="txt"></span>
            </div>
    </div>
    
    
<script type="text/javascript">
    function GetRequest() {
        var url = location.search; //获取url中"?"符后的字串
        var theRequest = new Object();
        if (url.indexOf("?") != -1) {
            var str = url.substr(1);
            strs = str.split("&");
            for (var i = 0; i < strs.length; i++) {
                theRequest[strs[i].split("=")[0]] = decodeURIComponent(strs[i].split("=")[1]);
            }
        }
        return theRequest;
    }
</script>
<script type="text/javascript">
    var m = new Map();
    m.set("北京","beijing");
    m.set("天津","tianjin");
    m.set("上海","shanghai");
    m.set("重庆","zhongqing");
    m.set("河北","hebei");
    m.set("山西","shanxi");
    m.set("内蒙古","neimenggu");
    m.set("辽宁","liaoning");
    m.set("吉林","jilin");
    m.set("黑龙江","heilongjian");
    m.set("江苏","jiangsu");
    m.set("浙江","zhejiang");
    m.set("安徽","anhui");
    m.set("福建","fujian");
    m.set("江西","jiangxi");
    m.set("山东","shandong");
    m.set("河南","henan");
    m.set("湖北","hubei");
    m.set("湖南","hunan");
    m.set("广东","guangdong");
    m.set("广西","guangxi");
    m.set("海南","hainan");
    m.set("四川","sichuan");
    m.set("贵州","guizhou");
    m.set("云南","yunnan");
    m.set("西藏","xizang");
    m.set("陕西","shanxi");
    m.set("甘肃","gansu");
    m.set("青海","qinghai");
    m.set("宁夏","ningxia");
    m.set("新疆","xinjiang");
    m.set("台湾","taiwan");
    m.set("香港","xianggang");
    m.set("澳门","aomen");
    var a = GetRequest();
    var cityName = a['cityName'];   //拼音

    if( localStorage.getItem("cityName") );
    else 
        localStorage.setItem("cityName", "天津");

    if(typeof(cityName)=="undefined"){ 
        cityName = localStorage.getItem("cityName");

        if(typeof(localStorage.getItem("cityName"))=="undefined")
            cityName = "天津";
    } 
    else{
        localStorage.setItem("cityName", cityName);
        
    }

    $('#city').text(cityName);

    var myChart = echarts.init(document.getElementById('hourslyChart'));

    $('#changeCity').click(function(){
        window.location.href='map.html';
    })
    $('#hourf').click(function(){
        $('#hourShow1').show();
        $('#hourShow2').show();
        $('#dayShow').hide();
    })
    $('#dayf').click(function(){
        $('#hourShow1').hide();
        $('#hourShow2').hide();
        $('#dayShow').show();
    })

    // 指定图表的配置项和数据
    var option = {
        tooltip: {
            trigger: 'axis'
        },
        legend: {
            data:['最高气温']
        },
        xAxis:  {
            show:false,
            type: 'category',
            boundaryGap: false,
            data: ['周一','周二','周三','周四','周五','周六','周日']
        },
        yAxis: {
            show:false,
            type: 'value',
            scale:true,
            axisLabel: {
                show:true,
                formatter: '{value} °C'
            }
        },
        series: [
            {
                type:'line',
                data:[11, 11, 15, 13, 12, 13, 10],
                label:{
                    normal:{
                        show:true,
                        position:'top',
                        offset:[0,-50],
                        formatter:'{c}℃',
                        textStyle:{
                            fontSize:24
                        }
                    }
                }
            }
        ]
    };
    myChart.setOption(option);
    $(document).ready(function(){
        $.ajax({
            url: "https://free-api.heweather.com/v5/now",
            type: "GET",
            dataType: "json",
            data: {
                city: cityName,
                key: "acaa23e4d1c54213bf5c7ced99127b27"
            },
    
            // When the requet completed, then invokes success function.
            success: function(data) {
                basicData = data.HeWeather5[0].basic; //基本信息
                nowData = data.HeWeather5[0].now;     //实况天气
                document.getElementById('hum').innerHTML = nowData.hum;
                document.getElementById('pcpn').innerHTML = nowData.pcpn;
                document.getElementById('pres').innerHTML = nowData.pres;
                document.getElementById('vis').innerHTML = nowData.vis;
                document.getElementById('sc').innerHTML = nowData.wind.sc;
                document.getElementById('dir').innerHTML = nowData.wind.dir;
                document.getElementById('condition').innerHTML = nowData.cond.txt;
                document.getElementById('tmp').innerHTML = nowData.tmp;
                var imagepath = "images/" + nowData.cond.code + ".png";
                $('#weatherCode').attr('src',imagepath);
            },
            error: function(e){
                alert("当前网络连接不可用，请联网后查询");
            }
    
        })
         $.ajax({
            url: "https://free-api.heweather.com/v5/suggestion",
            type: "GET",
            dataType: "json",
            data: {
                city: cityName,
                key: "acaa23e4d1c54213bf5c7ced99127b27"
            },
    
            // When the requet completed, then invokes success function.
            success: function(data) {
                basicData = data.HeWeather5[0].basic; //基本信息
                suggestData = data.HeWeather5[0].suggestion;     //实况天气

                $("#cw").find(".brf").text(suggestData.cw.brf);
                $("#cw").find(".txt").text(suggestData.cw.txt);
                
                $("#drsg").find(".brf").text(suggestData.drsg.brf);
                $("#drsg").find(".txt").text(suggestData.drsg.txt);

                $("#flu").find(".brf").text(suggestData.flu.brf);
                $("#flu").find(".txt").text(suggestData.flu.txt);
                               
                $("#uv").find(".brf").text(suggestData.uv.brf);
                $("#uv").find(".txt").text(suggestData.uv.txt);
               
                $("#sport").find(".brf").text(suggestData.sport.brf);
                $("#sport").find(".txt").text(suggestData.sport.txt);
            }
    
        })
        $.ajax({
            url: "https://free-api.heweather.com/v5/forecast",
            type: "GET",
            dataType: "json",
            data: {
                city: cityName,
                key: "acaa23e4d1c54213bf5c7ced99127b27"
            },
    
            // When the requet completed, then invokes success function.
            success: function(data) {
                forecastData = data.HeWeather5[0].daily_forecast;
                console.log(forecastData)
                var mydate = new Array();  //时间
                var tmp = new Array();
                var wind = new Array();

                var mydateString = "";
                var tmpString = "";
                var windString = "";
                var iconString = "";
                var condString = "";

                for(var i=0; i<3; i++){
                    mydate[i] = forecastData[i].date;
                    mydate[i] = mydate[i].substr(5,mydate[i].length);
                    tmp[i] = forecastData[i].tmp.min + '℃~' + forecastData[i].tmp.max +'℃';
                    wind[i] = forecastData[i].wind.dir + ' ' + forecastData[i].wind.sc + '级';
                    mydateString += "<td>" + mydate[i] + "</td>";
                    tmpString += "<td>" + tmp[i] + "</td>";
                    windString += "<td>" + wind[i] + "</td>";
                    iconString += "<td><img src=\"images/" + forecastData[i].cond.code_d + ".png\"/></td>";
                    condString += "<td>" + forecastData[i].cond.txt_d + "</td>";
                }
                document.getElementById('foreastDay').rows[0].innerHTML = mydateString;
                document.getElementById('foreastDay').rows[1].innerHTML = iconString;
                document.getElementById('foreastDay').rows[2].innerHTML = tmpString;
                document.getElementById('foreastDay').rows[3].innerHTML = condString;
                document.getElementById('foreastDay').rows[4].innerHTML = windString;
                

            },
            error: function(e){
                alert("当前网络连接不可用，请联网后查询");
            }
    
        })
        $.ajax({
            url: "http://api.openweathermap.org/data/2.5/forecast",
            type: "GET",
            dataType: "json",
            data: {
                q: m.get(cityName),
                APPID: "c39d92daaae3a5a5d1508300132f4127",
                cnt:"7",
                units:"metric"
            },
    
            // When the requet completed, then invokes success function.
            success: function(data) {
                var xAxisData = new Array();  //时间
                var tmpData = new Array();   //温度

                var hourString = "";    //时间
                var weatherString = "";   //天气

                for(var i=0; i<7; i++){
                    var utc = new Date(data.list[i].dt_txt);
                    var local = (utc.getHours()+8)%24;
                    hourString += "<td>" + local + "时</td>";
                    var code = data.list[i].weather[0].icon;
                    weatherString +="<td><img src=\"http://openweathermap.org/img/w/"+code+".png\"/></td>";
                    xAxisData[i] = local+"时";
                    tmpData[i] = Math.round(data.list[i].main.temp);
                    //alert(data.list[i].dt_txt);
                }
                document.getElementById('hourslyTable').rows[0].innerHTML = hourString;
                document.getElementById('hourslyTable').rows[1].innerHTML = weatherString;
                var option = {
                    xAxis:  {
                        position:'bottom',
                        type: 'category',
                        boundaryGap: false,
                        data: xAxisData
                    },
                    series: [
                        {
                            type:'line',
                            data:tmpData,
                            label:{
                                normal:{
                                    show:true,
                                    position:'top',
                                    offset:[0,-20],
                                    formatter:'{c}℃'
                                }
                            },
                            markPoint:{
                                data: [
                                   {
                                        //coord: [0,25],
                                        //symbol:'image://http://openweathermap.org/img/w/10d.png',
                                   }

                                ]
                            }
                        }
                    ]
                };
                myChart.setOption(option);
            }
    
        })
    });
</script>

</body>
</html>